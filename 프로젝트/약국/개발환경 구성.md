# Spring Boot Project

* Spring Initializer를 통해 프로젝트 생성 
  * JDK 11 
  * Spring boot 2.6.7 
  * Gradle
  * Lombok 
  * Spring Configuration Processor 
  * Spring Web 
  * Spring Data JPA 
  * MariaDB Driver

## IntelliJ 환경설정

1. Build, Run IntelliJ IDEA로 설정

   * Preferences > Build > Build Tools > Gradle 

     1. Build - IntelliJ IDEA로 선택

     2. Run - IntelliJ IDEA로 선택

2. lombok 활성화

   * Preferences > Build > Compiler > Annotaion Processors
     1. Enable annotaion processing 체크



## plugin 설치

* IntelliJ IDEA -> Preferences -> Plugins 에서 설치
  * Lombok, Handlebars, Spock Framework 등 설치 
  * (Optional) Key Promoter X, Grep Console, Rainbow Brackets, GitToolBox



## build.gradle 설정

1. plugins에서 Spring boot 2.6.7 버전 변경

2. DB dependency 잠시 주석처리

   *  jpa
   * db

   

## application 실행해 보기



## gitHub 연동

1. GitHub
   1. git repository 생성
   2. respository 주소 복사
2. Project
   1. git 생성 : `git init`
   2. local과 remote 연결 : `git remote add origin {repository 주소}`
   3. remote로 보낼 준비
      1. 변경사항 모두 보내기 : `git add .`
      2. 메시지 적기 : `git commit -m "first commit"`
   4. remote의 main branch로 보내기 : `git push origin main`



# Docker

## 설치

1. https://docs.docker.com/desktop/ 각 OS에 맞게 Docker 설치

   * 재시작
   * WSL2 --needed 뜨면 cmd에 `wsl --update`
   * 설치 확인 : cmd에  `docker -v`

2. https://hub.docker.com/ 무료 플랜으로 회원 가입 및 로그인 인증

   * 회원가입
   * 로그인  `docker login`
     * id : 소문자로 입력  
     * pwd 

3. docker-copose 설치(Linux만)

   1. 설치

      ```sh
      $ sudo curl -L https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/
      local/bin/docker-compose
      ```

   2. 설치 확인

      ```sh
      $ docker -v
      $ docker-compose -v
      ```



## App Container 생성

###  jar 파일 생성 

IntelliJ - terminal에서 진행

1. jar 파일 이름 설정

   * build.gradle에서 변경

     ```
     bootJar { archiveFileName = ‘app.jar’}
     ```

2. jar파일 생성

   ref) 삭제는 `gradlew clear`

   ```sh
   $ gradlew build (Window)
   $ ./gradlew build ( Linux, OSX)
   ```

3. jar 파일 확인

   경로 : build/libs/app.jar 

### Dockerfile 작성

1. Dockerfile 생성

   root project에 생성

2. 내용 작성

   * app

     ```
     FROM openjdk:11
     ARG JAR_FILE=build/libs/app.jar
     COPY ${JAR_FILE} ./app.jar
     ENV TZ=Asia/Seoul
     ENTRYPOINT ["java","-jar","./app.jar"]
     ```

   * db

     ```
     FROM mariadb:10
     ENV TZ=Asia/Seoul
     ```

   * redis

     ```
     FROM redis:6
     ENV TZ=Asia/Seoul
     ```

3. build

   ```sh
   docker build -t {dockerHub id}/{docker image 이름} .
   ```

4. docker image 확인

   ```sh
   docker images
   ```

### Docker Image 생성

IntelliJ - terminal에서 진행

1. build

   ```sh
   docker build -t {dockerHub id}/{docker image 이름} .
   ```

2. docker image 확인

   ```sh
   docker images
   ```



### Container 생성

1. Docker Image 실행

   ```sh
   docker run {dockerHub id}/{Docker Image 이름} -p {Host PORT}:{Container PORT}
   ```

2. 실행 확인 

   cmd에서 진행

   ```sh
   $ docker ps
   $ docker exec -it {CONTAINER ID} bash // 컨테이너를 bash 터미널 환경으로 접근
   $ docker stop [컨테이너 이름 또는 id]
   $ docker inspect [컨테이너 이름 또는 id]
   ```





1. dockerfile 작성

2. docker-compose-local.yml 작성

   1. mariadb

   2. redis

4. 환경변수 작성

   1. .env에 환경변수 작성
   2. .gitignore에 .env 추가

5. mariadb 한글깨지는거 설정

   1. 설정 파일 작성
   2. docker-compose에 추가

6. docker-compose 실행

7. terminal에서 Container 실행 확인 : `docker ps`

   1. mariadb
   2. redis

8. Spring boot에서 Container 확인

   1. application.yml에서 local profile 설정 추가
      1. mariaDB
      2. redis
      3. jpa
   2. build.gradle에서 db관련 주석 해제
   3. mariaDB 환경변수 추가

   

## DB,Redis Container 실습

### Dockerfile 작성

1. root project에 package 생성

   1. database
   2. redis

2. Dockerfile 작성

   1. database

      /database에 작성

      ```
      FROM mariadb:10
      ENV TZ=Asia/Seoul
      ```

   2. redis

      /redis에 작성

      ```
      FROM redis:6
      ENV TZ=Asia/Seoul
      ```



### docker-compose-local.yml 작성

1. docker-compose.yml 생성

   root project에서 생성

2. 내용 작성

   1. redis

   2. database

   ```yaml
   version: "3.8"                                    # 파일 규격 버전
   services:                                         # 이 항목 밑에 실행하려는 컨테이너들을 정의
     pharmacy-recommendation-redis:                        # 서비스명
       container_name: pharmacy-recommendation-redis       # 컨테이너 명
       build:
         dockerfile: Dockerfile
         context: ./redis
       image: zcx5674/pharmacy-recommendation-redis
       ports:
         - "6379:6379"
     pharmacy-recommendation-database:
       container_name: pharmacy-recommendation-database
       build:
         dockerfile: Dockerfile
         context: ./database
       image: zcx5674/pharmacy-recommendation-database
       environment:
         - MARIADB_DATABASE=pharmacy-recommendation
         - MARIADB_ROOT_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
       volumes:
         - ./database/config:/etc/mysql/conf.d
         - ./database/init:/docker-entrypoint-initdb.d
       ports:
         - "3306:3306"      # 접근 포트 설정 (컨테이너 외부:컨테이너 내부)
   ```



### .env에 환경변수 설정

1. .env 파일 생성

   root project에 생성

2. 환경변수 작성

   ```yaml
   SPRING_DATASOURCE_USERNAME=root
   SPRING_DATASOURCE_PASSWORD=1234
   ```

3. .gitignor에 .env 추가

   `.env`



### mariaDB 한글 깨짐 설정

1. config package 생성

   /database에 생성

2. 설정 작성

   /database/config에 작성



### local profile 설정

application.yml에 설정 추가

* mariaDB
* Redis
* JPA

```yaml
spring:
	config:
 		activate:
 			on-profile: local
 	datasource:	
 		driver-class-name: org.mariadb.jdbc.Driver
 		url: jdbc:mariadb://localhost:3306/pharmacy-recommendation
 		username: ${SPRING_DATASOURCE_USERNAME}
 		password: ${SPRING_DATASOURCE_PASSWORD}
 	redis:
 		host: localhost
        port: 6379
 	jpa:
 		hibernate:
 			ddl-auto: create	# 개발 환경에서만 create
 		show-sql: true
```



### docker-compose 실행

```sh
docker-compose -f docker-compose-local.yml
```



### Container 실행 확인

1. terminal에서  `docker ps`
2. Spring boot에서 확인
   1. 환경변수 추가
   2. application 실행



# Profile

* application 설정을 특정 환경에서만 적용되게 하기

* application-{Profile 이름}.yml

* spring boot 2.4 이전과 이후가 방법이 다름

  https://wonyong-jang.github.io/spring/2022/08/11/Spring-Profile.html

* resource - application.yml

  ```yaml
  spring:
    profiles:
      active: local 	# default profile
      group:
        local:
          - common	# common 적용
        prod:
          - common	# common 적용
  
  ---
  spring:
    config:
      activate:
        on-profile: common	# 공통 profile
  ---      
  spring:
    config:
      activate:
        on-profile: local	# profile1
  ---      
  spring:
    config:
      activate:
        on-profile: prod # profile2
  ```

  
