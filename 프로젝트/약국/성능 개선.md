# Redis

* 오픈소스

* in memory DB

  메모리 접근이 디스크 접근보다 빠르기 때문에 DB(Mysql, Oracle) 보다 빠름

* 다양한 자료구조

  https://redis.io/docs/data-types/tutorial/

* update가 자주 일어나지 않는 데이터에 효과적

  update가 자주 일어나면 Sync비용 발생하므로

* failover 고려

  조회 실패시 DB에서 조회

* CLI

* 자료구조

  * String

    key-value

  * Hash

    key-subkey-value

  * geospatial

    * 경도,위도
    * Haversine formula 알고리즘 사용하여 거리계산





실습

1. docker-compose 실행

2. docker 상태확인

3. redis docker에 접속

4. String 실습

   * set 
   * get
   * del
   * scan

5. Hash 자료구조

   * subkey의 값 지정
   * subkey값 조회
   * key의 모든 필드와 값들 조회

6. geospatial

   * 추가
   * 두 지역의 거리 구하기
   * 정해진 위도, 경도 기준으로 반경 10km 이내에 가까운 약국 찾기

   



# Redis Template 테스트 코드 작성

1. dependeny 추가
2. config에 template bean 생성
   1. application.yml에 등록된 host, port 값 가져오기
   2. host, port를 사용해서 connectFactory bean
   3. restTemplate bean
      1. 연결
      2. 여러가지 자료구조

3. 테스트 코드 작성(RedisTemplateTest)

   통합테스트

   자료구조 테스트

   1. @Autowired로 redisTemplate DI
   2. 테스트 작성
      1. String(key-value)
      2. Set(key-value)
      3. Hash(key-subkey-value)



# 성능개선 

1. in memory 방식(cache) 으로 개선

   1. config에 ObjectMapper bean 생성

   2. 생성자 주입(restTemplate, ObjectMapper)

   3. 생성자 주입 후, restTemplate으로 hash 자료구조 생성 함수 작성

   4. serialize method 작성

      약국dto를 Json 형식으로 바꾸기 by objectMapper

   5. deserialize method 작성

      Json을약국dto형식으로 바꾸기 by objectMapper

   6. save method 작성

      모든 dto마다

      1. subkey = dto.getId()

      2. value = serialize(dto)

      3. hash에 저장

      로그남기기

   7. findAll method

      hash의 values를 deserialize 해서 반환

      로그 남기기

   8. delete method

      hash에서 삭제

      로그남기기

2. 약국 데이터를 가져올 때 DB가 아닌 Redis로 하기
3. Redis가 비어있으면 DB 사용(failOver)
4. DB에 있는 데이터를 Redis에 동기화 하기
   1. Controller
      1. DI
         1. DB 데이터 조회 Service
         2. Redis 데이터 조회 Service
      2. GetMapping("경로")
      3. save method 작성
         1. DB 모든 데이터 조회
         2. 각 dto마다 Redis에 save



# 성능개선 테스트 코드 작성

* 단위 테스트(Service)

  PharmacySearchServiceTest

1. Mocking
   1. DI Service들
2. def setup()
   1. 생성자에 Mocking한 객체 DI
   2. 가상의 데이터 주입
3. 테스트 코드
   1. Redis fail시 DB에서 가져오는지
      1. when
         1. Redis empty list
         2. DB에 가상 데이터 주입
      2. then
         1. list size 확인



* 통합테스트

  실제로 Redis를 띄워서 진행하기 위해서

  PharmacyRedisTemplateServiceTest

1. DI

   1. Service

   2. def setup()

      1. Redis 비워주기

   3. save 테스트 코드

      1. given

         dto 주입

      2. when
         1. save 실행
         2. result = findAll 실행
      3. result 확인

   4. successs fail 테스트 코드
   5. delete 테스트 코드

2. 환경변수 추가(KEY)
3. test 실행



1. docker-compose 실행

2. application 실행

3. 웹브라우저로 확인

   1. 결과페이지 나올때까지 진행

   2. localhost:8080/redis/save 해보기

   3. 확인

      1. 웹브라우저 -> success나옴

      2. IntelliJ에서 log 확인 -> save 여러번 나옴

      3. cmd

         1. container 상태 확인

            `docker ps`

         2. redis container에 접속

            `docker exec -it {컨테이너 id} redis-cli --raw`

         3. 모든 subkey와 value 확인

            `hgetall PHARMACY`

   4. 웹브라우저 결과 화면에서 링크 눌러보기 -> IntellJ log에 `redis findAll success` 뜸
